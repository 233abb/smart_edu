<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µå•†æ™ºèƒ½å®¢æœ</title>
    <script src="/static/marked.min.js"></script>
    <script src="/static/purify.min.js"></script>
    <!-- å¼•å…¥ highlight.js ç”¨äºä»£ç é«˜äº®ï¼Œå¦‚æœä¸éœ€è¦å¯ä»¥ç§»é™¤ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --border-radius: 16px;
            --primary-color: #3b82f6;
            --background-color: #f8f7f6;
            --shadow-color: #00000026;
            --input-box-bg-color: #ffffffcb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Consolas", "å¾®è½¯é›…é»‘", sans-serif;
        }

        body {
            min-height: 100vh;
            background-color: var(--background-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
        }

        #dialog-area {
            flex: 1;
            width: 100%;
            max-width: 900px;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }

        .message-bubble {
            display: inline-flex;
            flex-direction: column; /* ç¡®ä¿å†…å®¹å‚ç›´æ’åˆ— */
            max-width: 90%; /* é™åˆ¶æœ€å¤§å®½åº¦ */
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: var(--border-radius);
            font-size: 16px;
            line-height: 1.5;
            word-break: break-word;
        }

        .new-message {
            animation: messageAppear 0.3s ease;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: none;
            }
        }

        .user-message {
            background-color: var(--primary-color);
            align-self: flex-end;
            color: white;
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .bot-message {
            background-color: #fff;
            align-self: flex-start;
            color: black;
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .input-box {
            width: 100%;
            max-width: 900px;
            padding: 16px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 8px var(--shadow-color);
            position: sticky;
            bottom: 16px;
            transition: all 0.3s ease;
            background-color: var(--input-box-bg-color);
            backdrop-filter: blur(8px);
            border: 2px solid transparent;

        }
        .input-box:hover {
            box-shadow: 0 4px 8px var(--primary-color);
        }
        .input-box:focus-within {
            border: 2px solid var(--primary-color);
        }

        #user-input {
            width: 100%;
            padding: 8px;
            font-size: 16px;
            max-height: 200px;
            overflow-y: auto;
            resize: none;
            border: none;
            outline: none;
            background-color: transparent;
        }

        #send-btn {
            padding: 8px 16px;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: auto;
            display: block;
            background-color: var(--primary-color);
        }
        #send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }
        #send-btn:active {
            transform: translateY(0);
        }
        #send-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .loading-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .loader {
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Markdown å†…å®¹æ ·å¼ --- */
        .markdown-content {
            max-width: 100%;
            overflow-x: auto;
        }

        /* ã€å…³é”®ä¿®å¤#1ã€‘: ç§»é™¤ä¹‹å‰é”™è¯¯çš„ br { display: none; } è§„åˆ™ */

        .markdown-content > *:first-child {
            margin-top: 0;
        }
        .markdown-content > *:last-child {
            margin-bottom: 0;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            margin: 1em 0 0.5em;
            color: var(--primary-color);
        }
        .markdown-content p {
            margin: 0.5em 0;
            line-height: 1.6;
        }
        .markdown-content ul, .markdown-content ol {
            margin: 0.5em 0;
            padding-left: 2em;
        }
        .markdown-content code {
            background-color: rgba(192, 192, 192, 0.2);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-family: Consolas, monospace;
        }
        .markdown-content pre {
            background-color: #2d2d2d; /* æš—è‰²ä»£ç å—èƒŒæ™¯ */
            color: #f8f8f2; /* äº®è‰²ä»£ç æ–‡æœ¬ */
            padding: 1em;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1em 0;
        }
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="dialog-area">
        <div class="bot-message message-bubble">
             <div class="markdown-content"><p>æ‚¨å¥½ï¼æˆ‘æ˜¯ç”µå•†æ™ºèƒ½å®¢æœï¼Œè¯·é—®æœ‰ä»€ä¹ˆéœ€è¦æˆ‘å¸®å¿™çš„ï¼Ÿ</p></div>
        </div>
    </div>
    <div class="input-box">
        <textarea id="user-input" placeholder="éœ€è¦æˆ‘åšä»€ä¹ˆï¼Ÿ"></textarea>
        <button id="send-btn" onclick="sendMessage()">å‘é€</button>
    </div>

<script>
    const dialogArea = document.getElementById('dialog-area');
    const input = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');

    // marked.js åˆå§‹åŒ–
    marked.setOptions({
        // ã€å…³é”®ä¿®å¤#2ã€‘: ç¦ç”¨breaksé€‰é¡¹ï¼Œå›å½’æ ‡å‡†Markdownè¡Œä¸ºï¼Œé¿å…äº§ç”Ÿå¤šä½™çš„<br>
        breaks: false,
        highlight: function (code, lang) {
            const language = hljs.getLanguage(lang) ? lang : 'plaintext';
            return hljs.highlight(code, { language }).value;
        }
    });

    async function sendMessage() {
        const message = input.value.trim();
        if (!message) return;

        sendBtn.disabled = true;
        addMessage(message, true); // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        input.value = '';
        input.style.height = 'auto';

        const botBubble = createBotBubble();
        dialogArea.appendChild(botBubble);
        const markdownContainer = botBubble.querySelector('.markdown-content');

        showLoading(markdownContainer, 'æ­£åœ¨è¿æ¥æœåŠ¡å™¨...');
        window.scrollTo(0, document.body.scrollHeight);

        // ã€å…³é”®ä¿®å¤#3ã€‘: ä½¿ç”¨ç´¯ç§¯å˜é‡æ¥ä¿è¯Markdownè§£æçš„æ­£ç¡®æ€§
        let fullMarkdownContent = "";

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const events = buffer.split('\n\n');
                buffer = events.pop(); // ä¿ç•™æœ€åä¸€ä¸ªä¸å®Œæ•´çš„äº‹ä»¶

                for (const eventStr of events) {
                    if (eventStr.trim() === "") continue;
                    try {
                        const event = JSON.parse(eventStr);
                        // ä¼ é€’ç´¯ç§¯å†…å®¹å¹¶è·å–æ›´æ–°åçš„å†…å®¹
                        fullMarkdownContent = handleStreamEvent(event, markdownContainer, fullMarkdownContent);
                    } catch (e) {
                        console.error("Error parsing stream event:", eventStr, e);
                    }
                }
            }
             if (buffer.trim()) {
                try {
                    const event = JSON.parse(buffer);
                    handleStreamEvent(event, markdownContainer, fullMarkdownContent);
                } catch (e) {
                    console.error("Error parsing final buffer:", buffer, e);
                }
            }

        } catch (error) {
            console.error('Fetch error:', error);
            showError(markdownContainer, 'ç³»ç»Ÿæš‚æ—¶æ— æ³•å“åº”ï¼Œè¯·ç¨åå†è¯•ğŸ˜¥');
        } finally {
            sendBtn.disabled = false;
        }
    }

    // handleStreamEventç°åœ¨æ¥æ”¶å¹¶è¿”å›ç´¯ç§¯çš„å†…å®¹
    function handleStreamEvent(event, container, currentContent) {
        switch (event.type) {
            case 'status':
                // åªæœ‰åœ¨è¿˜æ²¡æœ‰ä»»ä½•å†…å®¹æ—¶æ‰æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                if (!currentContent) {
                    showLoading(container, event.message);
                }
                break;
            case 'chunk':
                // ç´¯ç§¯åŸå§‹Markdownæ–‡æœ¬
                currentContent += event.content;
                // æ¯æ¬¡éƒ½é‡æ–°å®Œæ•´è§£æå’Œæ¸²æŸ“ï¼Œä¿è¯Markdownç»“æ„æ­£ç¡®
                container.innerHTML = DOMPurify.sanitize(marked.parse(currentContent));
                break;
            case 'final':
                console.log("Stream finished:", event.message);
                break;
            case 'error':
                showError(container, event.message);
                break;
            case 'cypher':
                console.log("Generated Cypher:\n", event.query);
                break;
        }
        window.scrollTo(0, document.body.scrollHeight);
        // è¿”å›æ›´æ–°åçš„å†…å®¹
        return currentContent;
    }

    function createBotBubble() {
        const bubble = document.createElement('div');
        bubble.classList.add('message-bubble', 'bot-message', 'new-message');
        const markdownContainer = document.createElement('div');
        markdownContainer.className = 'markdown-content';
        bubble.appendChild(markdownContainer);
        return bubble;
    }

    function showLoading(container, text) {
        container.innerHTML = `
            <div class="loading-container">
                <div class="loader"></div>
                <span>${text}</span>
            </div>`;
    }

    function showError(container, text) {
        container.innerHTML = `<p>${text}</p>`;
    }

    function addMessage(content, isUser) {
        const bubble = document.createElement('div');
        if (isUser) {
            bubble.classList.add('message-bubble', 'user-message', 'new-message');
            bubble.textContent = content;
        }
        // Bot messages are handled by createBotBubble
        dialogArea.appendChild(bubble);
        window.scrollTo(0, document.body.scrollHeight);
    }

    input.addEventListener('input', () => {
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 200) + 'px';
    });

    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
</script>
</body>
</html>