<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电商智能客服</title>
    <script src="/static/marked.min.js"></script>
    <script src="/static/purify.min.js"></script>
    <!-- 引入 highlight.js 用于代码高亮，如果不需要可以移除 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --border-radius: 16px;
            --primary-color: #3b82f6;
            --background-color: #f8f7f6;
            --shadow-color: #00000026;
            --input-box-bg-color: #ffffffcb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Consolas", "微软雅黑", sans-serif;
        }

        body {
            min-height: 100vh;
            background-color: var(--background-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
        }

        #dialog-area {
            flex: 1;
            width: 100%;
            max-width: 900px;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }

        .message-bubble {
            display: inline-flex;
            flex-direction: column; /* 确保内容垂直排列 */
            max-width: 90%; /* 限制最大宽度 */
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: var(--border-radius);
            font-size: 16px;
            line-height: 1.5;
            word-break: break-word;
        }

        .new-message {
            animation: messageAppear 0.3s ease;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: none;
            }
        }

        .user-message {
            background-color: var(--primary-color);
            align-self: flex-end;
            color: white;
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .bot-message {
            background-color: #fff;
            align-self: flex-start;
            color: black;
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .input-box {
            width: 100%;
            max-width: 900px;
            padding: 16px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 8px var(--shadow-color);
            position: sticky;
            bottom: 16px;
            transition: all 0.3s ease;
            background-color: var(--input-box-bg-color);
            backdrop-filter: blur(8px);
            border: 2px solid transparent;

        }
        .input-box:hover {
            box-shadow: 0 4px 8px var(--primary-color);
        }
        .input-box:focus-within {
            border: 2px solid var(--primary-color);
        }

        #user-input {
            width: 100%;
            padding: 8px;
            font-size: 16px;
            max-height: 200px;
            overflow-y: auto;
            resize: none;
            border: none;
            outline: none;
            background-color: transparent;
        }

        #send-btn {
            padding: 8px 16px;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: auto;
            display: block;
            background-color: var(--primary-color);
        }
        #send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }
        #send-btn:active {
            transform: translateY(0);
        }
        #send-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .loading-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .loader {
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Markdown 内容样式 --- */
        .markdown-content {
            max-width: 100%;
            overflow-x: auto;
        }

        /* 【关键修复#1】: 移除之前错误的 br { display: none; } 规则 */

        .markdown-content > *:first-child {
            margin-top: 0;
        }
        .markdown-content > *:last-child {
            margin-bottom: 0;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            margin: 1em 0 0.5em;
            color: var(--primary-color);
        }
        .markdown-content p {
            margin: 0.5em 0;
            line-height: 1.6;
        }
        .markdown-content ul, .markdown-content ol {
            margin: 0.5em 0;
            padding-left: 2em;
        }
        .markdown-content code {
            background-color: rgba(192, 192, 192, 0.2);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-family: Consolas, monospace;
        }
        .markdown-content pre {
            background-color: #2d2d2d; /* 暗色代码块背景 */
            color: #f8f8f2; /* 亮色代码文本 */
            padding: 1em;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1em 0;
        }
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="dialog-area">
        <div class="bot-message message-bubble">
             <div class="markdown-content"><p>您好！我是电商智能客服，请问有什么需要我帮忙的？</p></div>
        </div>
    </div>
    <div class="input-box">
        <textarea id="user-input" placeholder="需要我做什么？"></textarea>
        <button id="send-btn" onclick="sendMessage()">发送</button>
    </div>

<script>
    const dialogArea = document.getElementById('dialog-area');
    const input = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');

    // marked.js 初始化
    marked.setOptions({
        // 【关键修复#2】: 禁用breaks选项，回归标准Markdown行为，避免产生多余的<br>
        breaks: false,
        highlight: function (code, lang) {
            const language = hljs.getLanguage(lang) ? lang : 'plaintext';
            return hljs.highlight(code, { language }).value;
        }
    });

    async function sendMessage() {
        const message = input.value.trim();
        if (!message) return;

        sendBtn.disabled = true;
        addMessage(message, true); // 显示用户消息
        input.value = '';
        input.style.height = 'auto';

        const botBubble = createBotBubble();
        dialogArea.appendChild(botBubble);
        const markdownContainer = botBubble.querySelector('.markdown-content');

        showLoading(markdownContainer, '正在连接服务器...');
        window.scrollTo(0, document.body.scrollHeight);

        // 【关键修复#3】: 使用累积变量来保证Markdown解析的正确性
        let fullMarkdownContent = "";

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const events = buffer.split('\n\n');
                buffer = events.pop(); // 保留最后一个不完整的事件

                for (const eventStr of events) {
                    if (eventStr.trim() === "") continue;
                    try {
                        const event = JSON.parse(eventStr);
                        // 传递累积内容并获取更新后的内容
                        fullMarkdownContent = handleStreamEvent(event, markdownContainer, fullMarkdownContent);
                    } catch (e) {
                        console.error("Error parsing stream event:", eventStr, e);
                    }
                }
            }
             if (buffer.trim()) {
                try {
                    const event = JSON.parse(buffer);
                    handleStreamEvent(event, markdownContainer, fullMarkdownContent);
                } catch (e) {
                    console.error("Error parsing final buffer:", buffer, e);
                }
            }

        } catch (error) {
            console.error('Fetch error:', error);
            showError(markdownContainer, '系统暂时无法响应，请稍后再试😥');
        } finally {
            sendBtn.disabled = false;
        }
    }

    // handleStreamEvent现在接收并返回累积的内容
    function handleStreamEvent(event, container, currentContent) {
        switch (event.type) {
            case 'status':
                // 只有在还没有任何内容时才显示加载状态
                if (!currentContent) {
                    showLoading(container, event.message);
                }
                break;
            case 'chunk':
                // 累积原始Markdown文本
                currentContent += event.content;
                // 每次都重新完整解析和渲染，保证Markdown结构正确
                container.innerHTML = DOMPurify.sanitize(marked.parse(currentContent));
                break;
            case 'final':
                console.log("Stream finished:", event.message);
                break;
            case 'error':
                showError(container, event.message);
                break;
            case 'cypher':
                console.log("Generated Cypher:\n", event.query);
                break;
        }
        window.scrollTo(0, document.body.scrollHeight);
        // 返回更新后的内容
        return currentContent;
    }

    function createBotBubble() {
        const bubble = document.createElement('div');
        bubble.classList.add('message-bubble', 'bot-message', 'new-message');
        const markdownContainer = document.createElement('div');
        markdownContainer.className = 'markdown-content';
        bubble.appendChild(markdownContainer);
        return bubble;
    }

    function showLoading(container, text) {
        container.innerHTML = `
            <div class="loading-container">
                <div class="loader"></div>
                <span>${text}</span>
            </div>`;
    }

    function showError(container, text) {
        container.innerHTML = `<p>${text}</p>`;
    }

    function addMessage(content, isUser) {
        const bubble = document.createElement('div');
        if (isUser) {
            bubble.classList.add('message-bubble', 'user-message', 'new-message');
            bubble.textContent = content;
        }
        // Bot messages are handled by createBotBubble
        dialogArea.appendChild(bubble);
        window.scrollTo(0, document.body.scrollHeight);
    }

    input.addEventListener('input', () => {
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 200) + 'px';
    });

    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
</script>
</body>
</html>